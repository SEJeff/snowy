{% extends 'notes/base.html' %}

{% load i18n %}
{% load notes %}

{% block extra_head %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/DUI.js" charset="utf-8"></script>
{# Disable funcooker for now #}
{% comment %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/funcooker.js" charset="utf-8"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.scrollfollow.js" charset="utf-8"></script>
{% endcomment %}
<link href="{{ MEDIA_URL }}css/uitablefilter.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="{{ MEDIA_URL}}js/jquery.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/uitablefilter-setup.js"></script>

<script type="text/javascript" src="{{ MEDIA_URL}}js/jquery.uitablefilter.js"></script></head><body>
<script type="text/javascript">
 $(document).ready(function() {
     // Hide the invite new user link by default
     $('#invite').hide();
     var input = $('#filter');
     var popup = $('#sharing_container');
     // The current url + /sharing
     var url = "{% url note_share_no_slug note.author note.id %}";

     $('#share_button').click(function() {
       if (popup.hasClass("hidden") == true) {
         popup.removeClass("hidden");
         // Focus the input for usability
         input.focus();
       }
       else {
         popup.addClass("hidden");
       };
     });
     // TODO: Fully flesh this out for clicking the invite link
     $('#invite_link').click(function() {
       var email = input.val();
       $.post(url, {email: email},
         function(data) {
           // Hide and reset the input
           popup.addClass("hidden");
           input.val('');
           // TODO: Fix this
           alert("Returned: " + data);
           return false;
         });
     });

     function add_table_rows(json_list, header) {
     if (json_list.length > 0) {
         row = '<tr><td colspan="2">' + header + '</td></tr>\n';
         tbody.append(row);
     }
         // Loop over the list of users and add them to the popup
         for (i=0; i <= json_list.length - 1; i++) {
             row = "<tr><td class=\"center\"><input type=\"checkbox\" value=\""+json_list[i]+"\"checked></input></td><td>"+json_list[i]+"</td></tr>";
             tbody.append(row + "\n")
         }
     }

     var tbody = $('#filter_table tbody');
     // Add json to the dropdown "Share this note" menu
     /*
     $.getJSON(url, function(json) {
       add_table_rows(json.shared_with, "Shared with");
       //add_table_rows(json.invitations, "Invitations sent to these users");
       // This needs to happen _after_ the json adds the rows
       // otherwise hitting enter for checkboxes is broken
       // TODO: Put the list this gets from ajax in the view and move this back to uitablefilter-setup.js
       var popup_menu = $('table.filter_table');
       popup_menu.find("tbody > tr").find("td:eq(1)").mousedown(function(){
         $(this).prev().find(":checkbox").click();
       });
       ////////////////////////
     });
     */
    $('#public').click(function() {
      clicked = $(this).val() == "on";
      $.post(url, {'public': clicked}, function(value) {
        if (value == "OK") {
          var button = $("#share_button");
          var img = $("#share_button img");
          if (clicked == true) {
            var message = "Note {{ note.title }} is now public!";
            img.attr("src", "{{ MEDIA_URL }}img/public.png");
            button.attr("title", "This note is public");
          } else {
            var message = "Note {{ note.title }} is now private!";
            img.attr("src", "{{ MEDIA_URL }}img/private.png");
            button.attr("title", "This note is private");
          }
        } else {
            var message = "Problem with making note public/private!";
        }
        //alert(message);
        return false;
      });
    });
 });

</script>

{% endblock %}

{% block title %}{{ title|safe }} | Notes | {{ block.super }}{% endblock %}

{% block sidebar %}
{{ block.super }}
{% user_notes_list request author as list_notes %}
<div id="sidebar-note-list">
    <ul>
        {% for n in list_notes %}
        <li class="note-item{% if n.pinned %} pinned{% endif %}{% ifequal n note %} selected{% endifequal %}"><a href="{{ n.get_absolute_url }}{% if request.GET.query %}?query={{request.GET.query}}{% endif %}">{{ n.title|safe }}</a></li>
        {% endfor %}
        {% if request.GET.query %}
        <div style="text-align: center; margin: 3px;">
            <a href="."><input type="button" value="{% trans "Clear Search" %}" style="width:90%;"></a>
        </div>
        {% else %}
        <li class="more-item"><a href="{% url note_list author.username %}">{% trans "More Notes..." %}</a></li>
        {% endif %}
    </ul>
    <hr />
    <ul>
{# Enable when we allow editing #}
{% comment %}
        <li id="new-note"><a href="#">New Note...</a></li>
{% endcomment %}
    </ul>
</div>
<div id="sidebar-notebook-list">
    <h3>{% trans "Notebooks" %}</h3>
    <ul>
{% user_notebook_list request author as all_notebooks %}
{% include "notes/notebook_list_snippet.html" %}
        <li class="more-item"><a href="#">{% trans "More Notebooks..." %}</a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<button id="share_button" title="Share this note" style="margin-top: auto;">{% if note.permissions == 0 %}<img src="{{ MEDIA_URL }}img/private.png"</img>{% endif %}{% if note.permissions == 1 %}<img src="{{ MEDIA_URL }}img/public.png"</img>{% endif %}<!--Share this note--></button>
<div id="sharing_container" class="hidden popup">
 <form id="filter-form"><input class="invitation" id="filter" maxlength="50" size="30" type="text"></form>
 <table id="filter_table" class="filter_table fullwidth">
 <thead><tr id="invite"><th><a href="#" id="invite_link">Invite<span id="replace_email"></span> by email</a></th></tr></thead>
  <tbody><tr style="display: table-row;"></tr>
   <tr><td class="center"><input id="public" type="checkbox" {% if note.permissions == 1 %}checked{%endif %}></input></td><td>Make this note public</td></tr>
  </tbody>
 </table>
 </form>
</div>

<table id="content-layout" cellspacing="0" cellpadding="0">
    <tr>
        <td id="note">
            <h1>{{ title|safe }}</h1>
            <div id="funcooker">
                {{ body|safe }}
            </div>
        </td>
        <td>
{# Disable funcooker for now #}
{% comment %}
            <div id="toolbar">
                <h3>Text</h3>
                <p id="toolbar-text">
                    <a href="javascript:fc.normalStyle();" title="Normal">A</a>
                    <a href="javascript:fc.bold();" title="Bold"><b>A</b></a>
                    <a href="javascript:fc.strikethrough();" title="Strikethrough"><strike>A</strike></a>
                    <a href="javascript:fc.highlight();" title="Highlight"><span class="note-highlight">A</span></a>
                    <a href="javascript:fc.fixedWidth();" title="Fixed Width"><span class="note-monospace">A</span></a>
                </p>
                <h3>Font Size</h3>
                <p class="note-small"><a href="javascript:fc.small();">Small</a></p>
                <p><a href="javascript:fc.normalSize();">Normal</a></p>
                <p class="note-large"><a href="javascript:fc.large();">Large</a></p>
                <p class="note-huge"><a href="javascript:fc.huge();">Huge</a></p>
                <h3>Formatting</h3>
                <p><a href="#">Bullets</a></p>
                <p><a href="#">Increase Indent</a></p>
                <p><a href="#">Decrease Indent</a></p>
                <h3>Actions</h3>
                <p><a href="#">Link</a></p>
                <p><a href="#">Delete</a></p>
                <p><a href="#">History</a></p>
                <p><a href="#">Sharing</a></p>
            </div>
{% endcomment %}
        </td>
    </br>
</table>
{% comment %}
<script type="text/javascript">
var fc = null;
$(document).ready(function() {
    fc = new FunCooker("#funcooker");

    $('#toolbar').scrollFollow({
        speed: 200,
        offset: 10,
        container: 'content',
    });
});
</script>
{% endcomment %}
{% endblock %}
